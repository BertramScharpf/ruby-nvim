#!/usr/bin/env ruby

#
#  bin/neovim-ruby-host  --  Child started by Neovim
#

require "neovim/host"


module Neovim

  if $*.delete "--version" then
    puts [ INFO.name, INFO.version].join " "
    exit
  end

  class <<self

    def plugin &block
      require "neovim/vimscript_provider"
      run_dsl DslVimscript, &block
    end

    private

    def run_dsl dsl
      @host or raise "Can't add plugins outside of a running session."
      p = dsl.open @path do |dsl|
        yield dsl
      end
      @host.add_plugins @path, p
    end

  end

  r = Host.run do |h|
    begin
      @host = h
      $*.each do |p|
        @path = p
        Kernel.load @path, true
      ensure
        @path = nil
      end
    ensure
      @host = nil
    end
  end
  exit r.to_i

end

